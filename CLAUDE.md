# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

Docusaurusを使用した設計ドキュメントサイト。
pnpm workspaceによるモノレポ構成で、`docs/`パッケージがメインのDocusaurusサイト。

## 開発コマンド

```bash
# 依存関係のインストール
pnpm install

# ツールのインストール（kroki CLI等）
mise install

# 開発サーバー起動（docs/ディレクトリで実行）
cd docs && pnpm start

# 英語版で起動
cd docs && pnpm start --locale en

# ビルド
cd docs && pnpm build

# ビルド済みサイトのプレビュー
cd docs && pnpm serve

# 型チェック
cd docs && pnpm typecheck

# シェルスクリプトのテスト（BATS）
cd docs && pnpm test:scripts

# API ドキュメント生成（TypeDoc）
pnpm docs:api

# 翻訳ファイル生成
cd docs && pnpm docusaurus write-translations --locale en
```

## アーキテクチャ

### ディレクトリ構成

- `docs/` - Docusaurusサイト本体（workspaceパッケージ）
  - `content/` - Markdownドキュメントのソース
    - `adr/` - Architecture Decision Records
    - `architecture/` - アーキテクチャ設計
    - `specifications/` - 仕様書
    - `guides/` - ガイド・手順書
    - `frontend/` - フロントエンド関連
    - `bff/` - Backend for Frontend関連
  - `src/` - Reactコンポーネント・ページ
  - `static/` - 静的アセット
- `packages/` - 共有パッケージ
  - `sample-react/` - Reactコンポーネントライブラリ（TypeDocでAPIドキュメント生成）
  - `openapi/` - OpenAPI仕様ファイル

### 国際化（i18n）

- デフォルト言語: 日本語 (`ja`)
- 対応言語: 英語 (`en`)

### 主要な設定

- **サイドバー**: `docs/sidebars.ts` - 自動生成（`autogenerated`）で`content/`配下を構造化
- **Docusaurus設定**: `docs/docusaurus.config.ts`
- **Mermaid**: 有効（図表をMarkdown内で記述可能）
- **ブログ**: 無効化

## 環境要件

- Node.js 24.x（`mise.toml`で管理）
- pnpm 10.27.x（`package.json`の`packageManager`で固定）

## 新規ドキュメント作成

`docs/content/`配下の適切なカテゴリにMarkdownファイルを追加する。各カテゴリの`_category_.json`でサイドバーの表示順序やラベルを設定可能。frontmatterで`sidebar_position`を指定することで並び順を制御できる。

## 図の作成

### 対応形式

| 形式 | 拡張子 | 配置先 | 備考 |
|------|--------|--------|------|
| drawio | `.drawio.png` | `docs/static/diagrams/drawio/` | 変換不要（PNG画像かつ編集可能） |
| PlantUML | `.puml` | `docs/static/diagrams/src/plantuml/` | SVGに変換 |
| GraphViz | `.dot` | `docs/static/diagrams/src/graphviz/` | SVGに変換 |
| D2 | `.d2` | `docs/static/diagrams/src/d2/` | SVGに変換 |

### drawio図の作成・編集

`.drawio.png` 形式は PNG 画像でありながら編集データを内包しているため、変換処理が不要。

- **作成**: VS Code の Draw.io 拡張または draw.io Desktop で `.drawio.png` として保存
- **編集**: VS Code で直接開いて編集可能。保存時に PNG 画像部分が自動更新される
- **参照**: `![図](/diagrams/drawio/xxx.drawio.png)` で直接参照

### kroki形式の変換コマンド

```bash
# krokiサーバー起動（PlantUML/GraphViz/D2変換に必要）
pnpm kroki:up

# kroki形式の変換
cd docs && pnpm diagrams:kroki

# krokiサーバー停止
pnpm kroki:down
```

### 自動変換（pre-commit）

kroki形式（PlantUML, GraphViz, D2等）はコミット時に自動変換される（lefthook経由）。

### Markdownでの参照

```markdown
![システム構成図](/diagrams/drawio/system-architecture.drawio.png)
![認証シーケンス](/diagrams/output/plantuml/auth-sequence.svg)
```

### 注意事項

- **公開サーバー使用禁止**: kroki変換はローカルサーバー（`compose.yaml`）のみ使用
- **Docker必須**: krokiサーバーの実行に必要
- **kroki CLI**: miseで管理（`mise install`でインストール）
- **drawioは変換不要**: `.drawio.png` を直接配置・編集するため Docker 不要

## デプロイ

GitHub Pages へ自動デプロイ（`.github/workflows/deploy.yml`）。`main`ブランチへのpushで実行。

GitHub Pages向けビルド時は環境変数が必要となる。

```bash
BASE_URL=/sample-design-docs-docusaurus/ pnpm build
```
